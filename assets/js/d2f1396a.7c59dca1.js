"use strict";(self.webpackChunkfastify_website=self.webpackChunkfastify_website||[]).push([[7135],{3905:function(e,n,t){t.d(n,{Zo:function(){return d},kt:function(){return c}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),p=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},d=function(e){var n=p(e.components);return a.createElement(l.Provider,{value:n},e.children)},m={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(t),c=r,h=u["".concat(l,".").concat(c)]||u[c]||m[c]||i;return t?a.createElement(h,o(o({ref:n},d),{},{components:t})):a.createElement(h,o({ref:n},d))}));function c(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=u;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var p=2;p<i;p++)o[p]=t[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},3122:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return p},toc:function(){return d},default:function(){return u}});var a=t(7462),r=t(3366),i=(t(7294),t(3905)),o=["components"],s={title:"Validation and Serialization",sidebar_label:"Validation and Serialization",hide_title:!1},l=void 0,p={unversionedId:"Validation-and-Serialization",id:"version-v2/Validation-and-Serialization",isDocsHomePage:!1,title:"Validation and Serialization",description:"Fastify uses a schema-based approach, and even if it is not mandatory we recommend using JSON Schema to validate your routes and serialize your outputs. Internally, Fastify compiles the schema into a highly performant function.",source:"@site/versioned_docs/version-v2/Validation-and-Serialization.md",sourceDirName:".",slug:"/Validation-and-Serialization",permalink:"/website-next/docs/v2/Validation-and-Serialization",editUrl:"https://github.com/fastify/website-next/edit/main/docs/versioned_docs/version-v2/Validation-and-Serialization.md",tags:[],version:"v2",frontMatter:{title:"Validation and Serialization",sidebar_label:"Validation and Serialization",hide_title:!1},sidebar:"version-v2/tutorialSidebar",previous:{title:"TypeScript",permalink:"/website-next/docs/v2/TypeScript"},next:{title:"Write Plugin",permalink:"/website-next/docs/v2/Write-Plugin"}},d=[{value:"Validation",id:"validation",children:[{value:"Adding a shared schema",id:"adding-a-shared-schema",children:[],level:4},{value:"Retrieving a copy of shared schemas",id:"retrieving-a-copy-of-shared-schemas",children:[],level:4},{value:"Ajv Plugins",id:"ajv-plugins",children:[],level:4},{value:"Schema Compiler",id:"schema-compiler",children:[],level:4},{value:"Using other validation libraries",id:"using-other-validation-libraries",children:[{value:"Validation messages with other validation libraries",id:"validation-messages-with-other-validation-libraries",children:[],level:5}],level:4},{value:"Schema Resolver",id:"schema-resolver",children:[],level:4}],level:3},{value:"Serialization",id:"serialization",children:[],level:3},{value:"Error Handling",id:"error-handling",children:[],level:3},{value:"JSON Schema and Shared Schema support",id:"json-schema-and-shared-schema-support",children:[{value:"Examples",id:"examples",children:[],level:4}],level:3},{value:"Resources",id:"resources",children:[],level:3}],m={toc:d};function u(e){var n=e.components,t=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Fastify uses a schema-based approach, and even if it is not mandatory we recommend using ",(0,i.kt)("a",{parentName:"p",href:"http://json-schema.org/"},"JSON Schema")," to validate your routes and serialize your outputs. Internally, Fastify compiles the schema into a highly performant function."),(0,i.kt)("blockquote",null,(0,i.kt)("h2",{parentName:"blockquote",id:"--security-notice"},"\u26a0  Security Notice"),(0,i.kt)("p",{parentName:"blockquote"},"Treat the schema definition as application code.\nAs both validation and serialization features dynamically evaluate\ncode with ",(0,i.kt)("inlineCode",{parentName:"p"},"new Function()"),", it is not safe to use\nuser-provided schemas. See ",(0,i.kt)("a",{parentName:"p",href:"http://npm.im/ajv"},"Ajv")," and\n",(0,i.kt)("a",{parentName:"p",href:"http://npm.im/fast-json-stringify"},"fast-json-stringify")," for more\ndetails.")),(0,i.kt)("h3",{id:"validation"},"Validation"),(0,i.kt)("a",{name:"validation"}),(0,i.kt)("p",null,"The route validation internally relies upon ",(0,i.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/ajv"},"Ajv"),", which is a high-performance JSON schema validator. Validating the input is very easy: just add the fields that you need inside the route schema, and you are done! The supported validations are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"body"),": validates the body of the request if it is a POST, a PATCH or a PUT."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"querystring")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"query"),": validates the query string. This can be a complete JSON Schema object (with a ",(0,i.kt)("inlineCode",{parentName:"li"},"type")," property of ",(0,i.kt)("inlineCode",{parentName:"li"},"'object'")," and a ",(0,i.kt)("inlineCode",{parentName:"li"},"'properties'")," object containing parameters) or a simpler variation in which the ",(0,i.kt)("inlineCode",{parentName:"li"},"type")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"properties")," attributes are forgone and the query parameters are listed at the top level (see the example below)."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"params"),": validates the route params."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"headers"),": validates the request headers.")),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const bodyJsonSchema = {\n  type: 'object',\n  required: ['requiredKey'],\n  properties: {\n    someKey: { type: 'string' },\n    someOtherKey: { type: 'number' },\n    requiredKey: {\n      type: 'array',\n      maxItems: 3,\n      items: { type: 'integer' }\n    },\n    nullableKey: { type: ['number', 'null'] }, // or { type: 'number', nullable: true }\n    multipleTypesKey: { type: ['boolean', 'number'] },\n    multipleRestrictedTypesKey: {\n      oneOf: [\n        { type: 'string', maxLength: 5 },\n        { type: 'number', minimum: 10 }\n      ]\n    },\n    enumKey: {\n      type: 'string',\n      enum: ['John', 'Foo']\n    },\n    notTypeKey: {\n      not: { type: 'array' }\n    }\n  }\n}\n\nconst queryStringJsonSchema = {\n  type: 'object',\n  required: ['name'],\n  properties: {\n    name: { type: 'string' },\n    excitement: { type: 'integer' }\n  }\n}\n\n/* If you don't need required query strings,\n * A short hand syntax is also there:\n\nconst queryStringJsonSchema = {\n  name: { type: 'string' },\n  excitement: { type: 'integer' }\n}\n\n*/\n\n\nconst paramsJsonSchema = {\n  type: 'object',\n  properties: {\n    par1: { type: 'string' },\n    par2: { type: 'number' }\n  }\n}\n\nconst headersJsonSchema = {\n  type: 'object',\n  properties: {\n    'x-foo': { type: 'string' }\n  },\n  required: ['x-foo']\n}\n\nconst schema = {\n  body: bodyJsonSchema,\n\n  querystring: queryStringJsonSchema,\n\n  params: paramsJsonSchema,\n\n  headers: headersJsonSchema\n}\n\nfastify.post('/the/url', { schema }, handler)\n")),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"Note that Ajv will try to ",(0,i.kt)("a",{parentName:"em",href:"https://github.com/epoberezkin/ajv#coercing-data-types"},"coerce")," the values to the types specified in your schema ",(0,i.kt)("inlineCode",{parentName:"em"},"type")," keywords, both to pass the validation and to use the correctly typed data afterwards.")),(0,i.kt)("h4",{id:"adding-a-shared-schema"},"Adding a shared schema"),(0,i.kt)("a",{name:"shared-schema"}),(0,i.kt)("p",null,"Thanks to the ",(0,i.kt)("inlineCode",{parentName:"p"},"addSchema")," API, you can add multiple schemas to the Fastify instance and then reuse them in multiple parts of your application. As usual, this API is encapsulated."),(0,i.kt)("p",null,"There are two ways to reuse your shared schemas:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"$ref-way")),": as described in the ",(0,i.kt)("a",{parentName:"li",href:"https://tools.ietf.org/html/draft-handrews-json-schema-01#section-8"},"standard"),",\nyou can refer to an external schema. To use it you have to ",(0,i.kt)("inlineCode",{parentName:"li"},"addSchema")," with a valid ",(0,i.kt)("inlineCode",{parentName:"li"},"$id")," absolute URI."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"replace-way")),": this is a Fastify utility that lets you to substitute some fields with a shared schema.\nTo use it you have to ",(0,i.kt)("inlineCode",{parentName:"li"},"addSchema")," with an ",(0,i.kt)("inlineCode",{parentName:"li"},"$id")," having a relative URI fragment which is a simple string that\napplies only to alphanumeric chars ",(0,i.kt)("inlineCode",{parentName:"li"},"[A-Za-z0-9]"),".")),(0,i.kt)("p",null,"Here an overview on ",(0,i.kt)("em",{parentName:"p"},"how")," to set an ",(0,i.kt)("inlineCode",{parentName:"p"},"$id")," and ",(0,i.kt)("em",{parentName:"p"},"how")," references to it:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"replace-way"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"myField: 'foobar#'")," will search for a shared schema added with ",(0,i.kt)("inlineCode",{parentName:"li"},"$id: 'foobar'")))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"$ref-way"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"myField: { $ref: '#foo'}")," will search for field with ",(0,i.kt)("inlineCode",{parentName:"li"},"$id: '#foo'")," inside the current schema"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"myField: { $ref: '#/definitions/foo'}")," will search for field ",(0,i.kt)("inlineCode",{parentName:"li"},"definitions.foo")," inside the current schema"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"myField: { $ref: 'http://url.com/sh.json#'}")," will search for a shared schema added with ",(0,i.kt)("inlineCode",{parentName:"li"},"$id: 'http://url.com/sh.json'")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"myField: { $ref: 'http://url.com/sh.json#/definitions/foo'}")," will search for a shared schema added with ",(0,i.kt)("inlineCode",{parentName:"li"},"$id: 'http://url.com/sh.json'")," and will use the field ",(0,i.kt)("inlineCode",{parentName:"li"},"definitions.foo")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"myField: { $ref: 'http://url.com/sh.json#foo'}")," will search for a shared schema added with ",(0,i.kt)("inlineCode",{parentName:"li"},"$id: 'http://url.com/sh.json'")," and it will look inside of it for object with ",(0,i.kt)("inlineCode",{parentName:"li"},"$id: '#foo'"))))),(0,i.kt)("p",null,"More examples:"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("inlineCode",{parentName:"strong"},"$ref-way"))," usage examples:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"fastify.addSchema({\n  $id: 'http://example.com/common.json',\n  type: 'object',\n  properties: {\n    hello: { type: 'string' }\n  }\n})\n\nfastify.route({\n  method: 'POST',\n  url: '/',\n  schema: {\n    body: {\n      type: 'array',\n      items: { $ref: 'http://example.com/common.json#/properties/hello' }\n    }\n  },\n  handler: () => {}\n})\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("inlineCode",{parentName:"strong"},"replace-way"))," usage examples:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify')()\n\nfastify.addSchema({\n  $id: 'greetings',\n  type: 'object',\n  properties: {\n    hello: { type: 'string' }\n  }\n})\n\nfastify.route({\n  method: 'POST',\n  url: '/',\n  schema: {\n    body: 'greetings#'\n  },\n  handler: () => {}\n})\n\nfastify.register((instance, opts, done) => {\n\n  /**\n   * In children's scope can use schemas defined in upper scope like 'greetings'.\n   * Parent scope can't use the children schemas.\n   */\n  instance.addSchema({\n    $id: 'framework',\n    type: 'object',\n    properties: {\n      fastest: { type: 'string' },\n      hi: 'greetings#'\n    }\n  })\n\n  instance.route({\n    method: 'POST',\n    url: '/sub',\n    schema: {\n      body: 'framework#'\n    },\n    handler: () => {}\n  })\n\n  done()\n})\n")),(0,i.kt)("p",null,"You can use the shared schema everywhere, as top level schema or nested inside other schemas:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify')()\n\nfastify.addSchema({\n  $id: 'greetings',\n  type: 'object',\n  properties: {\n    hello: { type: 'string' }\n  }\n})\n\nfastify.route({\n  method: 'POST',\n  url: '/',\n  schema: {\n    body: {\n      type: 'object',\n      properties: {\n        greeting: 'greetings#',\n        timestamp: { type: 'number' }\n      }\n    }\n  },\n  handler: () => {}\n})\n")),(0,i.kt)("h4",{id:"retrieving-a-copy-of-shared-schemas"},"Retrieving a copy of shared schemas"),(0,i.kt)("a",{name:"get-shared-schema"}),(0,i.kt)("p",null,"The function ",(0,i.kt)("inlineCode",{parentName:"p"},"getSchemas")," returns the shared schemas available in the selected scope:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"fastify.addSchema({ $id: 'one', my: 'hello' })\nfastify.get('/', (request, reply) => { reply.send(fastify.getSchemas()) })\n\nfastify.register((instance, opts, done) => {\n  instance.addSchema({ $id: 'two', my: 'ciao' })\n  instance.get('/sub', (request, reply) => { reply.send(instance.getSchemas()) })\n\n  instance.register((subinstance, opts, done) => {\n    subinstance.addSchema({ $id: 'three', my: 'hola' })\n    subinstance.get('/deep', (request, reply) => { reply.send(subinstance.getSchemas()) })\n    done()\n  })\n  done()\n})\n")),(0,i.kt)("p",null,"This example will returns:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"URL"),(0,i.kt)("th",{parentName:"tr",align:null},"Schemas"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"/"),(0,i.kt)("td",{parentName:"tr",align:null},"one")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"/sub"),(0,i.kt)("td",{parentName:"tr",align:null},"one, two")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"/deep"),(0,i.kt)("td",{parentName:"tr",align:null},"one, two, three")))),(0,i.kt)("h4",{id:"ajv-plugins"},"Ajv Plugins"),(0,i.kt)("a",{name:"ajv-plugins"}),(0,i.kt)("p",null,"You can provide a list of plugins you want to use with Ajv:"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Refer to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Server.md#factory-ajv"},(0,i.kt)("inlineCode",{parentName:"a"},"ajv options"))," to check plugins format")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify')({\n  ajv: {\n    plugins: [\n      require('ajv-merge-patch')\n    ]\n  }\n})\n\nfastify.route({\n  method: 'POST',\n  url: '/',\n  schema: {\n    body: {\n      $patch: {\n        source: {\n          type: 'object',\n          properties: {\n            q: {\n              type: 'string'\n            }\n          }\n        },\n        with: [\n          {\n            op: 'add',\n            path: '/properties/q',\n            value: { type: 'number' }\n          }\n        ]\n      }\n    }\n  },\n  handler (req, reply) {\n    reply.send({ ok: 1 })\n  }\n})\n\nfastify.route({\n  method: 'POST',\n  url: '/',\n  schema: {\n    body: {\n      $merge: {\n        source: {\n          type: 'object',\n          properties: {\n            q: {\n              type: 'string'\n            }\n          }\n        },\n        with: {\n          required: ['q']\n        }\n      }\n    }\n  },\n  handler (req, reply) {\n    reply.send({ ok: 1 })\n  }\n})\n")),(0,i.kt)("h4",{id:"schema-compiler"},"Schema Compiler"),(0,i.kt)("a",{name:"schema-compiler"}),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"schemaCompiler")," is a function that returns a function that validates the body, url parameters, headers, and query string. The default ",(0,i.kt)("inlineCode",{parentName:"p"},"schemaCompiler")," returns a function that implements the ",(0,i.kt)("a",{parentName:"p",href:"https://ajv.js.org/"},"ajv")," validation interface. Fastify uses it internally to speed the validation up."),(0,i.kt)("p",null,"Fastify's ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/epoberezkin/ajv#options-to-modify-validated-data"},"baseline ajv configuration")," is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'{\n  removeAdditional: true, // remove additional properties\n  useDefaults: true, // replace missing properties and items with the values from corresponding default keyword\n  coerceTypes: true, // change data type of data to match type keyword\n  nullable: true     // support keyword "nullable" from Open API 3 specification.\n}\n')),(0,i.kt)("p",null,"This baseline configuration can be modified by providing ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Server.md#factory-ajv"},(0,i.kt)("inlineCode",{parentName:"a"},"ajv.customOptions"))," to your Fastify factory."),(0,i.kt)("p",null,"If you want to change or set additional config options, you will need to create your own instance and override the existing one like:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify')()\nconst Ajv = require('ajv')\nconst ajv = new Ajv({\n  // the fastify defaults (if needed)\n  removeAdditional: true,\n  useDefaults: true,\n  coerceTypes: true,\n  nullable: true,\n  // any other options\n  // ...\n})\nfastify.setSchemaCompiler(function (schema) {\n  return ajv.compile(schema)\n})\n\n// -------\n// Alternatively, you can set the schema compiler using the setter property:\nfastify.schemaCompiler = function (schema) { return ajv.compile(schema) })\n")),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},(0,i.kt)("strong",{parentName:"em"},"Note:")," If you use a custom instance of any validator (even Ajv), you have to add schemas to the validator instead of fastify, since fastify's default validator is no longer used, and fastify's ",(0,i.kt)("inlineCode",{parentName:"em"},"addSchema")," method has no idea what validator you are using.")),(0,i.kt)("h4",{id:"using-other-validation-libraries"},"Using other validation libraries"),(0,i.kt)("a",{name:"using-other-validation-libraries"}),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"schemaCompiler")," function makes it easy to substitute ",(0,i.kt)("inlineCode",{parentName:"p"},"ajv")," with almost any Javascript validation library (",(0,i.kt)("a",{parentName:"p",href:"https://github.com/hapijs/joi/"},"joi"),", ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/jquense/yup/"},"yup"),", ...)."),(0,i.kt)("p",null,"However, in order to make your chosen validation engine play well with Fastify's request/response pipeline, the function returned by your ",(0,i.kt)("inlineCode",{parentName:"p"},"schemaCompiler")," function should return an object with either :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"in case of validation failure: an ",(0,i.kt)("inlineCode",{parentName:"li"},"error")," property, filled with an instance of ",(0,i.kt)("inlineCode",{parentName:"li"},"Error")," or a string that describes the validation error"),(0,i.kt)("li",{parentName:"ul"},"in case of validation success: an ",(0,i.kt)("inlineCode",{parentName:"li"},"value")," property, filled with the coerced value that passed the validation")),(0,i.kt)("p",null,"The examples below are therefore equivalent:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const joi = require('joi')\n\n// Validation options to match ajv's baseline options used in Fastify\nconst joiOptions = {\n  abortEarly: false, // return all errors\n  convert: true, // change data type of data to match type keyword\n  allowUnknown : false, // remove additional properties\n  noDefaults: false\n}\n\nconst joiBodySchema = joi.object().keys({\n  age: joi.number().integer().required(),\n  sub: joi.object().keys({\n    name: joi.string().required()\n  }).required()\n})\n\nconst joiSchemaCompiler = schema => data => {\n  // joi `validate` function returns an object with an error property (if validation failed) and a value property (always present, coerced value if validation was successful)\n  const { error, value } = joiSchema.validate(data, joiOptions)\n  if (error) {\n    return { error }\n  } else {\n    return { value }\n  }\n}\n\n// or more simply...\nconst joiSchemaCompiler = schema => data => joiSchema.validate(data, joiOptions)\n\nfastify.post('/the/url', {\n  schema: {\n    body: joiBodySchema\n  },\n  schemaCompiler: joiSchemaCompiler\n}, handler)\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const yup = require('yup')\n\n// Validation options to match ajv's baseline options used in Fastify\nconst yupOptions = {\n  strict: false,\n  abortEarly: false, // return all errors\n  stripUnknown: true, // remove additional properties\n  recursive: true\n}\n\nconst yupBodySchema = yup.object({\n  age: yup.number().integer().required(),\n  sub: yup.object().shape({\n    name: yup.string().required()\n  }).required()\n})\n\nconst yupSchemaCompiler = schema => data => {\n  // with option strict = false, yup `validateSync` function returns the coerced value if validation was successful, or throws if validation failed\n  try {\n    const result = schema.validateSync(data, yupOptions)\n    return { value: result }\n  } catch (e) {\n    return { error: e }\n  }\n}\n\nfastify.post('/the/url', {\n  schema: {\n    body: yupBodySchema\n  },\n  schemaCompiler: yupSchemaCompiler\n}, handler)\n")),(0,i.kt)("h5",{id:"validation-messages-with-other-validation-libraries"},"Validation messages with other validation libraries"),(0,i.kt)("p",null,"Fastify's validation error messages are tightly coupled to the default validation engine: errors returned from ",(0,i.kt)("inlineCode",{parentName:"p"},"ajv")," are eventually run through the ",(0,i.kt)("inlineCode",{parentName:"p"},"schemaErrorsText")," function which is responsible for building human-friendly error messages. However, the ",(0,i.kt)("inlineCode",{parentName:"p"},"schemaErrorsText")," function is written with ",(0,i.kt)("inlineCode",{parentName:"p"},"ajv")," in mind : as a result, you may run into odd or incomplete error messages when using other validation librairies."),(0,i.kt)("p",null,"To circumvent this issue, you have 2 main options :"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"make sure your validation function (returned by your custom ",(0,i.kt)("inlineCode",{parentName:"li"},"schemaCompiler"),") returns errors in the exact same structure and format as ",(0,i.kt)("inlineCode",{parentName:"li"},"ajv")," (although this could prove to be difficult and tricky due to differences between validation engines)"),(0,i.kt)("li",{parentName:"ol"},"or use a custom ",(0,i.kt)("inlineCode",{parentName:"li"},"errorHandler")," to intercept and format your 'custom' validation errors")),(0,i.kt)("p",null,"To help you in writing a custom ",(0,i.kt)("inlineCode",{parentName:"p"},"errorHandler"),", Fastify adds 2 properties to all validation errors:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"validation: the content of the ",(0,i.kt)("inlineCode",{parentName:"li"},"error")," property of the object returned by the validation function (returned by your custom ",(0,i.kt)("inlineCode",{parentName:"li"},"schemaCompiler"),")"),(0,i.kt)("li",{parentName:"ul"},"validationContext: the 'context' (body, params, query, headers) where the validation error occurred")),(0,i.kt)("p",null,"A very contrived example of such a custom ",(0,i.kt)("inlineCode",{parentName:"p"},"errorHandler")," handling validation errors is shown below:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const errorHandler = (error, request, reply) => {\n\n  const statusCode = error.statusCode\n  let response\n\n  const { validation, validationContext } = error\n\n  // check if we have a validation error\n  if (validation) {\n    response = {\n      message: `A validation error occured when validating the ${validationContext}...`, // validationContext will be 'body' or 'params' or 'headers' or 'query'\n      errors: validation // this is the result of your validation library...\n    }\n  } else {\n    response = {\n      message: 'An error occurred...'\n    }\n  }\n\n  // any additional work here, eg. log error\n  // ...\n\n  reply.status(statusCode).send(response)\n\n}\n")),(0,i.kt)("h4",{id:"schema-resolver"},"Schema Resolver"),(0,i.kt)("a",{name:"schema-resolver"}),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"schemaResolver")," is a function that works together with the ",(0,i.kt)("inlineCode",{parentName:"p"},"schemaCompiler"),": you can't use it\nwith the default schema compiler. This feature is useful when you use complex schemas with ",(0,i.kt)("inlineCode",{parentName:"p"},"$ref")," keyword\nin your routes and a custom validator."),(0,i.kt)("p",null,"This is needed because all the schemas you add to your custom compiler are unknown to Fastify but it\nneed to resolve the ",(0,i.kt)("inlineCode",{parentName:"p"},"$ref")," paths."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify')()\nconst Ajv = require('ajv')\nconst ajv = new Ajv()\n\najv.addSchema({\n  $id: 'urn:schema:foo',\n  definitions: {\n    foo: { type: 'string' }\n  },\n  type: 'object',\n  properties: {\n    foo: { $ref: '#/definitions/foo' }\n  }\n})\najv.addSchema({\n  $id: 'urn:schema:response',\n  type: 'object',\n  required: ['foo'],\n  properties: {\n    foo: { $ref: 'urn:schema:foo#/definitions/foo' }\n  }\n})\najv.addSchema({\n  $id: 'urn:schema:request',\n  type: 'object',\n  required: ['foo'],\n  properties: {\n    foo: { $ref: 'urn:schema:foo#/definitions/foo' }\n  }\n})\n\nfastify.setSchemaCompiler(schema => ajv.compile(schema))\nfastify.setSchemaResolver((ref) => {\n  return ajv.getSchema(ref).schema\n})\n\nfastify.route({\n  method: 'POST',\n  url: '/',\n  schema: {\n    body: { $ref: 'urn:schema:request#' },\n    response: {\n      '2xx': { $ref: 'urn:schema:response#' }\n    }\n  },\n  handler (req, reply) {\n    reply.send({ foo: 'bar' })\n  }\n})\n")),(0,i.kt)("h3",{id:"serialization"},"Serialization"),(0,i.kt)("a",{name:"serialization"}),(0,i.kt)("p",null,"Usually you will send your data to the clients via JSON, and Fastify has a powerful tool to help you, ",(0,i.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/fast-json-stringify"},"fast-json-stringify"),", which is used if you have provided an output schema in the route options. We encourage you to use an output schema, as it will increase your throughput by 100-400% depending on your payload and will prevent accidental disclosure of sensitive information."),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const schema = {\n  response: {\n    200: {\n      type: 'object',\n      properties: {\n        value: { type: 'string' },\n        otherValue: { type: 'boolean' }\n      }\n    }\n  }\n}\n\nfastify.post('/the/url', { schema }, handler)\n")),(0,i.kt)("p",null,"As you can see, the response schema is based on the status code. If you want to use the same schema for multiple status codes, you can use ",(0,i.kt)("inlineCode",{parentName:"p"},"'2xx'"),", for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const schema = {\n  response: {\n    '2xx': {\n      type: 'object',\n      properties: {\n        value: { type: 'string' },\n        otherValue: { type: 'boolean' }\n      }\n    },\n    201: {\n      type: 'object',\n      properties: {\n        value: { type: 'string' }\n      }\n    }\n  }\n}\n\nfastify.post('/the/url', { schema }, handler)\n")),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"If you need a custom serializer in a very specific part of your code, you can set one with ",(0,i.kt)("inlineCode",{parentName:"em"},"reply.serializer(...)"),".")),(0,i.kt)("h3",{id:"error-handling"},"Error Handling"),(0,i.kt)("p",null,"When schema validation fails for a request, Fastify will automtically return a  status 400 response including the result from the validator in the payload. As an example, if you have the following schema for your route"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const schema = {\n  body: {\n    type: 'object',\n    properties: {\n      name: { type: 'string' }\n    },\n    required: ['name']\n  }\n}\n")),(0,i.kt)("p",null,"and fail to satisfy it, the route will immediately return a response with the following payload"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'{\n  "statusCode": 400,\n  "error": "Bad Request",\n  "message": "body should have required property \'name\'"\n}\n')),(0,i.kt)("p",null,"If you want to handle errors inside the route, you can specify the ",(0,i.kt)("inlineCode",{parentName:"p"},"attachValidation")," option for your route. If there is a validation error, the ",(0,i.kt)("inlineCode",{parentName:"p"},"validationError")," property of the request will contain the ",(0,i.kt)("inlineCode",{parentName:"p"},"Error")," object with the raw ",(0,i.kt)("inlineCode",{parentName:"p"},"validation")," result as shown below"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = Fastify()\n\nfastify.post('/', { schema, attachValidation: true }, function (req, reply) {\n  if (req.validationError) {\n    // `req.validationError.validation` contains the raw validation error\n    reply.code(400).send(req.validationError)\n  }\n})\n")),(0,i.kt)("p",null,"You can also use ",(0,i.kt)("a",{parentName:"p",href:"https://www.fastify.io/docs/latest/Server/#seterrorhandler"},"setErrorHandler")," to define a custom response for validation errors such as"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"fastify.setErrorHandler(function (error, request, reply) {\n  if (error.validation) {\n     // error.validationContext can be on of [body, params, querystring, headers]\n     reply.status(422).send(new Error(`validation failed of the ${error.validationContext}`))\n  }\n})\n")),(0,i.kt)("p",null,"If you want custom error response in schema without headaches and quickly, you can take a look at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/epoberezkin/ajv-errors"},(0,i.kt)("inlineCode",{parentName:"a"},"ajv-errors")),". Checkout the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/fastify/example/blob/master/validation-messages/custom-errors-messages.js"},"example")," usage."),(0,i.kt)("p",null,"Below is an example showing how to add ",(0,i.kt)("strong",{parentName:"p"},"custom error messages for each property")," of a schema by supplying custom AJV options.\nInline comments in the schema below describe how to configure it to show a different error message for each case:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = Fastify({\n  ajv: {\n    customOptions: { jsonPointers: true },\n    plugins: [\n      require('ajv-errors')\n    ]\n  }\n})\n\nconst schema = {\n  body: {\n    type: 'object',\n    properties: {\n      name: {\n        type: 'string',\n        errorMessage: {\n          type: 'Bad name'\n        }\n      },\n      age: {\n        type: 'number',\n        errorMessage: {\n          type: 'Bad age', // specify custom message for\n          min: 'Too young' // all constraints except required\n        }\n      }\n    },\n    required: ['name', 'age'],\n    errorMessage: {\n      required: {\n        name: 'Why no name!', // specify error message for when the\n        age: 'Why no age!' // property is missing from input\n      }\n    }\n  }\n}\n\nfastify.post('/', { schema, }, (request, reply) => {\n  reply.send({\n    hello: 'world'\n  })\n})\n")),(0,i.kt)("p",null,"If you want to return localized error messages, take a look at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/epoberezkin/ajv-i18n"},"ajv-i18n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const localize = require('ajv-i18n')\n\nconst fastify = Fastify()\n\nconst schema = {\n  body: {\n    type: 'object',\n    properties: {\n      name: {\n        type: 'string',\n      },\n      age: {\n        type: 'number',\n      }\n    },\n    required: ['name', 'age'],\n  }\n}\n\nfastify.setErrorHandler(function (error, request, reply) {\n  if (error.validation) {\n    localize.ru(error.validation)\n    reply.status(400).send(error.validation)\n    return\n  }\n  reply.send(error)\n})\n")),(0,i.kt)("h3",{id:"json-schema-and-shared-schema-support"},"JSON Schema and Shared Schema support"),(0,i.kt)("p",null,"JSON Schema has some type of utilities in order to optimize your schemas that,\nin conjuction with the Fastify's shared schema, let you reuse all your schemas easily."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Use Case"),(0,i.kt)("th",{parentName:"tr",align:null},"Validator"),(0,i.kt)("th",{parentName:"tr",align:null},"Serializer"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"shared schema"),(0,i.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f"),(0,i.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"$ref")," to ",(0,i.kt)("inlineCode",{parentName:"td"},"$id")),(0,i.kt)("td",{parentName:"tr",align:null},"\ufe0f\ufe0f\u2714\ufe0f"),(0,i.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"$ref")," to ",(0,i.kt)("inlineCode",{parentName:"td"},"/definitions")),(0,i.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f"),(0,i.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"$ref")," to shared schema ",(0,i.kt)("inlineCode",{parentName:"td"},"$id")),(0,i.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f"),(0,i.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"$ref")," to shared schema ",(0,i.kt)("inlineCode",{parentName:"td"},"/definitions")),(0,i.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f"),(0,i.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f")))),(0,i.kt)("h4",{id:"examples"},"Examples"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// Usage of the Shared Schema feature\nfastify.addSchema({\n  $id: 'sharedAddress',\n  type: 'object',\n  properties: {\n    city: { 'type': 'string' }\n  }\n})\n\nconst sharedSchema = {\n  type: 'object',\n  properties: {\n    home: 'sharedAddress#',\n    work: 'sharedAddress#'\n  }\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// Usage of $ref to $id in same JSON Schema\nconst refToId = {\n  type: 'object',\n  definitions: {\n    foo: {\n      $id: '#address',\n      type: 'object',\n      properties: {\n        city: { 'type': 'string' }\n      }\n    }\n  },\n  properties: {\n    home: { $ref: '#address' },\n    work: { $ref: '#address' }\n  }\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// Usage of $ref to /definitions in same JSON Schema\nconst refToDefinitions = {\n  type: 'object',\n  definitions: {\n    foo: {\n      $id: '#address',\n      type: 'object',\n      properties: {\n        city: { 'type': 'string' }\n      }\n    }\n  },\n  properties: {\n    home: { $ref: '#/definitions/foo' },\n    work: { $ref: '#/definitions/foo' }\n  }\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// Usage $ref to a shared schema $id as external schema\nfastify.addSchema({\n  $id: 'http://foo/common.json',\n  type: 'object',\n  definitions: {\n    foo: {\n      $id: '#address',\n      type: 'object',\n      properties: {\n        city: { 'type': 'string' }\n      }\n    }\n  }\n})\n\nconst refToSharedSchemaId = {\n  type: 'object',\n  properties: {\n    home: { $ref: 'http://foo/common.json#address' },\n    work: { $ref: 'http://foo/common.json#address' }\n  }\n}\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// Usage $ref to a shared schema /definitions as external schema\nfastify.addSchema({\n  $id: 'http://foo/common.json',\n  type: 'object',\n  definitions: {\n    foo: {\n      type: 'object',\n      properties: {\n        city: { 'type': 'string' }\n      }\n    }\n  }\n})\n\nconst refToSharedSchemaDefinitions = {\n  type: 'object',\n  properties: {\n    home: { $ref: 'http://foo/common.json#/definitions/foo' },\n    work: { $ref: 'http://foo/common.json#/definitions/foo' }\n  }\n}\n")),(0,i.kt)("h3",{id:"resources"},"Resources"),(0,i.kt)("a",{name:"resources"}),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://json-schema.org/"},"JSON Schema")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://spacetelescope.github.io/understanding-json-schema/"},"Understanding JSON schema")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/fastify/fast-json-stringify"},"fast-json-stringify documentation")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/epoberezkin/ajv/blob/master/README.md"},"Ajv documentation")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/epoberezkin/ajv-i18n"},"Ajv i18n")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/epoberezkin/ajv-errors"},"Ajv custom errors")),(0,i.kt)("li",{parentName:"ul"},"Custom error handling with core methods with error file dumping ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/fastify/example/tree/master/validation-messages"},"example"))))}u.isMDXComponent=!0}}]);